<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Directorio de contactos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #f5f5f5;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 28px 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
    }
    h1 {
      font-size: 24px;
      margin: 0 0 4px 0;
    }
    .subtitle {
      font-size: 13px;
      color: #666666;
      margin-bottom: 18px;
    }
    .search-bar {
      margin-bottom: 12px;
    }
    .search-bar input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #dddddd;
      font-size: 14px;
      outline: none;
    }
    .search-bar input:focus {
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66,133,244,0.15);
    }
    .table-wrapper {
      max-height: 480px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px 10px;
      font-size: 13px;
      text-align: left;
    }
    th {
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td {
      background: #fcfcfc;
    }
    tr:hover td {
      background: #f1f5ff;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e8f0fe;
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .type-pill {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #e0f2f1;
      text-transform: capitalize;
    }
    .type-pill.persona {
      background: #e8f0fe;
    }
    .type-pill.empresa {
      background: #e6f4ea;
    }

    .email-link, .phone-link {
      text-decoration: none;
      color: #1a73e8;
    }
    .empty-row {
      text-align: center;
      color: #777777;
      font-size: 13px;
    }
    .status {
      margin-top: 10px;
      font-size: 12px;
      color: #777777;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Directorio de contactos</h1>
    <div class="subtitle">
      Usa el buscador para filtrar por nombre, teléfono, correo, plataforma, dirección o notas.
    </div>

    <div class="search-bar">
      <input id="search" type="text" placeholder="Buscar...">
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Teléfono</th>
            <th>Correo</th>
            <th>Plataformas</th>
            <th>Dirección</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody id="tabla-cuerpo"></tbody>
      </table>
    </div>

    <div id="estado" class="status"></div>
  </div>

  <!-- PapaParse: librería para leer CSV de forma robusta -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // 1) Pega aquí la URL CSV de tu Google Sheet
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/1T3jxg376sNzDJ1IRGRwtowGmmfenfqXPtHrIqEltB1c/export?format=csv&id=1T3jxg376sNzDJ1IRGRwtowGmmfenfqXPtHrIqEltB1c&gid=0';

    let contactos = [];
    let searchInput;
    let tbody;
    let estado;

    function normalizar(texto) {
      return (texto || '')
        .toString()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }

    function render(lista) {
      tbody.innerHTML = '';

      if (!Array.isArray(lista) || lista.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.className = 'empty-row';
        td.textContent = 'No hay resultados para tu búsqueda.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        estado.textContent = '0 contactos encontrados.';
        return;
      }

      lista.forEach(function(item) {
        const tr = document.createElement('tr');

        const tdNombre = document.createElement('td');
        tdNombre.textContent = item.nombre || '';

        const tdTipo = document.createElement('td');
        if (item.tipo) {
        const span = document.createElement('span');
        // clase base + clase según el texto (persona / empresa)
        span.className = 'type-pill ' + normalizar(item.tipo);
        span.textContent = item.tipo;
        tdTipo.appendChild(span);
        }
        
        const tdTel = document.createElement('td');
        if (item.telefono) {
          const a = document.createElement('a');
          a.href = 'tel:' + item.telefono.toString().replace(/\s+/g, '');
          a.textContent = item.telefono;
          a.className = 'phone-link';
          tdTel.appendChild(a);
        }

        const tdCorreo = document.createElement('td');
        if (item.correo) {
          const a = document.createElement('a');
          a.href = 'mailto:' + item.correo;
          a.textContent = item.correo;
          a.className = 'email-link';
          tdCorreo.appendChild(a);
        }

        const tdPlataformas = document.createElement('td');
        if (item.plataformas) {
          item.plataformas
            .toString()
            .split(',')
            .map(s => s.trim())
            .filter(Boolean)
            .forEach(function(p) {
              const span = document.createElement('span');
              span.className = 'tag';
              span.textContent = p;
              tdPlataformas.appendChild(span);
            });
        }

        const tdDireccion = document.createElement('td');
        tdDireccion.textContent = item.direccion || '';

        const tdNotas = document.createElement('td');
        tdNotas.textContent = item.notas || '';

        tr.appendChild(tdNombre);
        tr.appendChild(tdTipo);
        tr.appendChild(tdTel);
        tr.appendChild(tdCorreo);
        tr.appendChild(tdPlataformas);
        tr.appendChild(tdDireccion);
        tr.appendChild(tdNotas);

        tbody.appendChild(tr);
      });

      estado.textContent = lista.length + ' contacto(s) mostrados.';
    }

    function filtrar() {
      const q = normalizar(searchInput.value);

      if (!q) {
        render(contactos);
        return;
      }

      const filtrados = contactos.filter(function(item) {
        return (
          normalizar(item.nombre).includes(q) ||
          normalizar(item.tipo).includes(q) ||
          normalizar(item.telefono).includes(q) ||
          normalizar(item.correo).includes(q) ||
          normalizar(item.plataformas).includes(q) ||
          normalizar(item.direccion).includes(q) ||
          normalizar(item.notas).includes(q)
        );
      });

      render(filtrados);
    }

    function cargarDatos() {
      estado.textContent = 'Cargando contactos...';

      fetch(CSV_URL)
        .then(function(resp) {
          if (!resp.ok) {
            throw new Error('No se pudo cargar el CSV, código ' + resp.status);
          }
          return resp.text();
        })
        .then(function(texto) {
          const resultado = Papa.parse(texto, {
            header: true,
            skipEmptyLines: true
          });

          if (resultado.errors && resultado.errors.length > 0) {
            console.error('Errores al parsear CSV:', resultado.errors);
          }

          contactos = resultado.data.map(function(row) {
            return {
              nombre: row.Nombre || '',
              tipo: row.Tipo || '',
              telefono: row.Telefono || '',
              correo: row.Correo || '',
              plataformas: row.Plataformas || '',
              direccion: row.Direccion || '',
              notas: row.Notas || ''
            };
          });

          render(contactos);
        })
        .catch(function(err) {
          console.error(err);
          estado.textContent = 'Error al cargar datos. Revisa la URL del CSV y los permisos de la hoja.';
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
      searchInput = document.getElementById('search');
      tbody = document.getElementById('tabla-cuerpo');
      estado = document.getElementById('estado');

      searchInput.addEventListener('input', filtrar);

      cargarDatos();
    });
  </script>
</body>
</html>
